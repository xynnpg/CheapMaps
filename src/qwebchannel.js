"use strict"; var QWebChannelMessageTypes = { signal: 1, propertyUpdate: 2, init: 3, idle: 4, debug: 5, invokeMethod: 6, connectToSignal: 7, disconnectFromSignal: 8, setProperty: 9, response: 10 }; var QWebChannel = function (transport, initCallback) { if (typeof transport !== "object" || typeof transport.send !== "function") { console.error("The QWebChannel expects a transport object with a send function and onmessage callback property. Given is: transport: " + typeof transport + ", transport.send: " + typeof transport.send); return } var channel = this; this.transport = transport; this.send = function (data) { if (typeof data !== "string") { data = JSON.stringify(data) } channel.transport.send(data) }; this.execCallbacks = {}; this.execId = 0; this.exec = function (data, callback) { if (!callback) { channel.send(data); return } if (channel.execId === Number.MAX_VALUE) { channel.execId = Number.MIN_VALUE } if (data.hasOwnProperty("id")) { console.error("Cannot exec message with property id: " + JSON.stringify(data)); return } data.id = channel.execId++; channel.execCallbacks[data.id] = callback; channel.send(data) }; this.objects = {}; this.handleSignal = function (message) { var object = channel.objects[message.object]; if (object) { object.signalEmitted(message.signal, message.args) } else { console.warn("Unhandled signal: " + message.object + "::" + message.signal) } }; this.handleResponse = function (message) { if (!message.hasOwnProperty("id")) { console.error("Invalid response message received: ", JSON.stringify(message)); return } channel.execCallbacks[message.id](message.data); delete channel.execCallbacks[message.id] }; this.handlePropertyUpdate = function (message) { for (var i in message.data) { var data = message.data[i]; var object = channel.objects[data.object]; if (object) { object.propertyUpdate(data.signals, data.properties) } else { console.warn("Unhandled property update: " + data.object + "::" + data.signal) } } channel.exec({ type: QWebChannelMessageTypes.idle }) }; this.debug = function (message) { console.log("Debug message received: ", message.data) }; this.transport.onmessage = function (message) { var data = message.data; if (typeof data === "string") { data = JSON.parse(data) } switch (data.type) { case QWebChannelMessageTypes.signal: channel.handleSignal(data); break; case QWebChannelMessageTypes.response: channel.handleResponse(data); break; case QWebChannelMessageTypes.propertyUpdate: channel.handlePropertyUpdate(data); break; case QWebChannelMessageTypes.debug: channel.debug(data); break; default: console.error("Invalid message received: ", message.type) } }; channel.exec({ type: QWebChannelMessageTypes.init }, function (data) { for (var objectName in data) { var object = new QObject(objectName, data[objectName], channel) } for (var objectName in data) { var object = channel.objects[objectName]; object.unwrapQObject(data[objectName]) } if (initCallback) { initCallback(channel) } }) }; var QObject = function (name, data, webChannel) { this.__id__ = name; webChannel.objects[name] = this; this.__objectSignals__ = {}; this.__propertyCache__ = {}; var object = this; this.unwrapQObject = function (response) { for (var i in response.signals) { var signalName = response.signals[i][0]; var signalIndexes = response.signals[i][1]; object.__objectSignals__[signalName] = object.__objectSignals__[signalName] || []; for (var j in signalIndexes) { var signalNameWithIndex = signalName + "" + signalIndexes[j]; object.__objectSignals__[signalNameWithIndex] = object.__objectSignals__[signalNameWithIndex] || []; object[signalName] = object.signalEmit(signalName, signalIndexes[j]) } } for (var i in response.methods) { var methodName = response.methods[i][0]; var methodIndexes = response.methods[i][1]; for (var j in methodIndexes) { var methodNameWithIndex = methodName + "" + methodIndexes[j]; object[methodName] = object.methodCall(methodName, methodIndexes[j]) } } for (var i in response.properties) { var propertyName = response.properties[i][0]; var propertyIndex = response.properties[i][1]; object[propertyName] = null; var propertyNameWithIndex = propertyName + "" + propertyIndex; object.__propertyCache__[propertyIndex] = propertyName; Object.defineProperty(object, propertyName, { configurable: true, get: function (propertyIndex) { return function () { return object.propertyGet(propertyIndex) } }.apply(object, [propertyIndex]), set: function (propertyIndex) { return function (value) { object.propertySet(propertyIndex, value) } }.apply(object, [propertyIndex]) }) } }; this.signalEmit = function (signalName, signalIndex) { var signal = function () { webChannel.exec({ type: QWebChannelMessageTypes.invokeMethod, object: object.__id__, method: signalIndex, args: Array.prototype.slice.call(arguments) }) }; signal.connect = function (callback) { var signals = object.__objectSignals__[signalName + "" + signalIndex]; if (signals) { signals.push(callback); if (!signal.connected) { webChannel.exec({ type: QWebChannelMessageTypes.connectToSignal, object: object.__id__, signal: signalIndex }); signal.connected = true } } else { console.warn("Signal connect: " + signalName + " NOT found for " + object.__id__) } }; signal.disconnect = function (callback) { var signals = object.__objectSignals__[signalName + "" + signalIndex]; if (signals) { var index = signals.indexOf(callback); if (index !== -1) { signals.splice(index, 1); if (signals.length === 0) { signal.connected = false; webChannel.exec({ type: QWebChannelMessageTypes.disconnectFromSignal, object: object.__id__, signal: signalIndex }) } } } else { console.warn("Signal disconnect: " + signalName + " NOT found for " + object.__id__) } }; return signal }; this.methodCall = function (methodName, methodIndex) { return function () { var args = Array.prototype.slice.call(arguments); var callback = args[args.length - 1]; if (typeof callback === "function") { args.pop() } else { callback = undefined } webChannel.exec({ type: QWebChannelMessageTypes.invokeMethod, object: object.__id__, method: methodIndex, args: args }, function (response) { if (response !== undefined) { if (callback) { callback(response) } } }) } }; this.propertyGet = function (propertyIndex) { var propertyName = object.__propertyCache__[propertyIndex]; return object[propertyName] }; this.propertySet = function (propertyIndex, value) { webChannel.exec({ type: QWebChannelMessageTypes.setProperty, object: object.__id__, property: propertyIndex, value: value }) }; this.signalEmitted = function (signalName, signalArgs) { var signals = object.__objectSignals__[signalName]; if (signals) { for (var i in signals) { signals[i].apply(object, signalArgs) } } }; this.propertyUpdate = function (signals, properties) { for (var signalName in signals) { var signalArgs = signals[signalName]; object.signalEmitted(signalName, signalArgs) } for (var propertyIndex in properties) { var propertyValue = properties[propertyIndex]; var propertyName = object.__propertyCache__[propertyIndex]; if (propertyName) { object[propertyName] = propertyValue } } } };
